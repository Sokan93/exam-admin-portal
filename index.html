<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Admin Panel</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        .tab-btn.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
    </style>

    <!-- External Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Main Container -->
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Password Modal -->
        <div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-sm">
                <h2 class="text-xl sm:text-2xl font-bold text-center mb-4">Admin Access</h2>
                <p class="text-slate-500 text-center mb-6">Please enter the password to continue.</p>
                <input type="password" id="password-input" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition mb-4" placeholder="Password">
                <button id="password-submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Login</button>
                <p id="password-error" class="text-red-500 text-sm mt-2 text-center"></p>
            </div>
        </div>

        <!-- Main Content (Hidden by default) -->
        <div id="main-content" class="hidden">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-6">Admin Portal</h1>

            <!-- Tabs -->
            <div class="border-b border-slate-200 mb-8">
                <nav class="-mb-px flex space-x-4 sm:space-x-8 overflow-x-auto" aria-label="Tabs">
                    <button id="tab-management" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg text-indigo-600">Exam Management</button>
                    <button id="tab-dashboard" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base sm:text-lg text-slate-500 hover:text-slate-700">Dashboard</button>
                </nav>
            </div>

            <!-- Exam Management View -->
            <div id="management-view">
                <div id="exam-list-container">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                        <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Exam List</h2>
                        <button id="add-exam-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-indigo-700">+ Add New Exam</button>
                    </div>
                    <div class="bg-white p-4 sm:p-8 rounded-2xl shadow-lg">
                        <div id="exam-list" class="space-y-4">
                            <p id="loading-exams" class="text-slate-500">Loading exams...</p>
                        </div>
                    </div>
                </div>
                <div id="exam-editor" class="hidden mt-10 bg-white p-4 sm:p-8 rounded-2xl shadow-lg"></div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="hidden">
                <!-- Overall Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow">
                        <h3 class="text-slate-500 text-lg">Total Submissions</h3>
                        <p id="total-submissions" class="text-3xl sm:text-4xl font-bold">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow">
                        <h3 class="text-slate-500 text-lg">Unique Students</h3>
                        <p id="unique-students" class="text-3xl sm:text-4xl font-bold">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow">
                        <h3 class="text-slate-500 text-lg">Average Score</h3>
                        <p id="average-score" class="text-3xl sm:text-4xl font-bold">0%</p>
                    </div>
                </div>
                <!-- Exam Performance Section -->
                <div class="bg-white p-4 sm:p-8 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-6">Exam Performance</h2>
                    <select id="exam-select" class="w-full p-2 border border-slate-300 rounded-lg mb-6"></select>
                    <div id="exam-details" class="hidden">
                        <div class="mb-8"><canvas id="score-chart"></canvas></div>
                        <h3 class="text-lg sm:text-xl font-semibold mb-4">Individual Scores</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Score</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="scores-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Student Report Card Section -->
                <div class="bg-white p-4 sm:p-8 rounded-2xl shadow-lg">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-6">Student Report Card</h2>
                    <div class="flex flex-col sm:flex-row gap-2 mb-6">
                        <input type="text" id="student-search-input" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Enter Student ID">
                        <button id="student-search-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Search</button>
                    </div>
                    <div id="student-report-container"></div>
                </div>
            </div>
            
            <!-- Submissions Viewer Modal (shared) -->
            <div id="submissions-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"></div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, onSnapshot, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyADB3h5RdKrpvIKyVCZmb70QsARMvFTg_A",
            authDomain: "mcq-quiz-epc.firebaseapp.com",
            projectId: "mcq-quiz-epc",
            storageBucket: "mcq-quiz-epc.firebasestorage.app",
            messagingSenderId: "774044608813",
            appId: "1:774044608813:web:22db4c3b0c2a737893cba4",
            measurementId: "G-6TJ955EYDR"
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="text-center text-red-500 p-8">Could not connect to the database.</div>`;
        }
        
        // --- Authentication ---
        const ADMIN_PASSWORD = "admin";
        document.getElementById('password-submit').addEventListener('click', () => {
            if (document.getElementById('password-input').value === ADMIN_PASSWORD) {
                document.getElementById('password-modal').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                loadManagementData();
            } else {
                document.getElementById('password-error').textContent = "Incorrect password.";
            }
        });

        // --- Global State ---
        let allSubmissions = [], allExams = [], allStudents = [];
        let scoreChart = null;

        // --- DOM Elements ---
        const managementView = document.getElementById('management-view');
        const dashboardView = document.getElementById('dashboard-view');
        const examEditorEl = document.getElementById('exam-editor');
        const submissionsModalEl = document.getElementById('submissions-modal');
        const examListContainer = document.getElementById('exam-list-container');

        // --- Tab Switching Logic ---
        const tabManagement = document.getElementById('tab-management');
        const tabDashboard = document.getElementById('tab-dashboard');
        tabManagement.addEventListener('click', () => switchTab('management'));
        tabDashboard.addEventListener('click', () => switchTab('dashboard'));

        function switchTab(tabName) {
            if (tabName === 'management') {
                managementView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                tabManagement.classList.add('active');
                tabDashboard.classList.remove('active');
            } else {
                managementView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                tabManagement.classList.remove('active');
                tabDashboard.classList.add('active');
                loadDashboardData();
            }
        }
        
        // --- Exam Management ---
        function loadManagementData() {
            onSnapshot(collection(db, 'exams'), (snapshot) => {
                const examList = document.getElementById('exam-list');
                const loadingEl = document.getElementById('loading-exams');
                if (loadingEl) loadingEl.classList.add('hidden');
                examList.innerHTML = '';
                
                if (snapshot.empty) {
                    examList.innerHTML = '<p class="text-slate-500">No exams found. Click "Add New Exam" to get started.</p>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const exam = { id: doc.id, ...doc.data() };
                    const examEl = document.createElement('div');
                    examEl.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border rounded-lg gap-4';
                    const studentCount = exam.allowedStudentIDs?.length || 0;
                    const accessType = studentCount > 0 ? `${studentCount} student(s)` : 'Private';

                    examEl.innerHTML = `
                        <div>
                            <p class="font-bold text-lg">${exam.title}</p>
                            <p class="text-sm text-slate-500">${exam.questions?.length || 0} questions | Access: <span class="font-semibold">${accessType}</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                            <button data-id="${exam.id}" data-title="${exam.title}" class="flex-1 sm:flex-none submissions-btn bg-blue-500 text-white font-semibold py-1 px-3 rounded hover:bg-blue-600 text-sm">Submissions</button>
                            <button data-id="${exam.id}" class="flex-1 sm:flex-none edit-btn bg-yellow-400 text-white font-semibold py-1 px-3 rounded hover:bg-yellow-500 text-sm">Edit</button>
                            <button data-id="${exam.id}" class="flex-1 sm:flex-none delete-btn bg-red-500 text-white font-semibold py-1 px-3 rounded hover:bg-red-600 text-sm">Delete</button>
                        </div>
                    `;
                    examList.appendChild(examEl);
                });
            });
        }

        function showEditor(s
